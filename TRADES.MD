# Diff√©rence entre TRADE et TRANSFER

## üîÑ TRADE (Swap)

Un **trade** est un **√©change de tokens**. L'utilisateur donne un token et re√ßoit un autre token.

### Caract√©ristiques d'un trade:
- ‚úÖ 2 mouvements de tokens dans **la m√™me transaction**
- ‚úÖ Token A sort du wallet (outgoing)
- ‚úÖ Token B entre dans le wallet (incoming)
- ‚úÖ Passage par un DEX (Jupiter, Raydium, Orca, Pump.fun, etc.)
- ‚úÖ Instructions swap dans la transaction

### Exemples de trades:
1. **Acheter un memecoin**
   - OUT: 1 SOL
   - IN: 1,000,000 BONK
   - DEX: Jupiter Aggregator

2. **Vendre un token**
   - OUT: 500 USDC
   - IN: 0.5 SOL
   - DEX: Raydium

3. **Trade via bot (Axiom, Padre, etc.)**
   - OUT: 0.1 SOL
   - IN: 50,000 TOKEN
   - DEX: Pump.fun via Axiom
   - Note: Le bot appelle le DEX, c'est toujours un swap!

### Identification dans Helius:
```javascript
// Transaction avec type "SWAP"
{
  type: "SWAP",
  source: "JUPITER_V6", // ou RAYDIUM, ORCA, PUMP_FUN
  tokenTransfers: [
    { fromUserAccount: true, amount: 1000000 }, // SOL out
    { toUserAccount: true, amount: 5000000 }    // TOKEN in
  ]
}
```

---

## üì§ TRANSFER

Un **transfer** est un **envoi simple** d'un token d'un wallet √† un autre. Pas d'√©change.

### Caract√©ristiques d'un transfer:
- ‚úÖ 1 seul mouvement de token
- ‚úÖ Direction unique (soit IN, soit OUT)
- ‚úÖ Pas de DEX impliqu√©
- ‚úÖ Type: "TRANSFER" dans Helius

### Exemples de transfers:

1. **Envoyer des SOL √† un ami**
   - OUT: 5 SOL
   - Destination: Wallet d'un ami

2. **Recevoir des tokens**
   - IN: 100 USDC
   - Source: Binance, ami, etc.

3. **D√©poser sur une plateforme**
   - OUT: 10 SOL
   - Destination: Adresse de d√©p√¥t CEX

### Identification dans Helius:
```javascript
// Transaction avec type "TRANSFER"
{
  type: "TRANSFER",
  tokenTransfers: [
    { fromUserAccount: true, amount: 5000000 } // Uniquement OUT
  ]
}
```

---

## ü§ñ CAS SP√âCIAUX: Bots de trading

### Axiom, Padre.app, BonkBot, etc.

**IMPORTANT**: Les bots ne font PAS de transferts, ils font des SWAPS!

Quand un utilisateur trade via un bot:
1. User envoie une commande au bot (Telegram, interface web)
2. Le bot **ex√©cute un swap** sur un DEX
3. La transaction blockchain = SWAP standard

### Exemple concret:

**User commande via Axiom:**
```
/buy 0.5 SOL of BONK
```

**Transaction r√©sultante sur Solana:**
```javascript
{
  type: "SWAP",
  source: "JUPITER_V6",  // Axiom utilise Jupiter
  description: "Swapped 0.5 SOL for 1.2M BONK",
  tokenTransfers: [
    { token: "SOL", fromUserAccount: true, amount: 0.5 },
    { token: "BONK", toUserAccount: true, amount: 1200000 }
  ]
}
```

**C'est un TRADE, pas un transfer!**

---

## ‚ö†Ô∏è Probl√®mes actuels dans le code

### 1. Mauvaise cat√©gorisation

Le code actuel peut classifier certains swaps comme transfers si:
- La transaction a un seul `tokenTransfer` visible
- Le parsing Helius ne d√©tecte pas le swap
- Les bots utilisent des instructions custom

### 2. Code √† v√©rifier

`lib/solana-transactions.ts` ligne ~100-150:

```typescript
// PROBL√àME: Si on se base uniquement sur tokenTransfers.length
if (tokenTransfers.length === 1) {
  return "transfer"; // ‚ùå FAUX pour certains swaps!
}
```

### 3. Solutions

**Option A: Utiliser `type` de Helius** (recommand√©)
```typescript
const txType = enrichedTx.type; // "SWAP", "TRANSFER", etc.
if (txType === "SWAP") {
  return "swap";
}
```

**Option B: D√©tecter les instructions DEX**
```typescript
const instructions = tx.transaction.message.instructions;
const isDexSwap = instructions.some(ix =>
  DEX_PROGRAM_IDS.includes(ix.programId)
);
```

**Option C: V√©rifier les tokenTransfers bidirectionnels**
```typescript
const hasIncoming = tokenTransfers.some(t => t.toUserAccount);
const hasOutgoing = tokenTransfers.some(t => t.fromUserAccount);
if (hasIncoming && hasOutgoing) {
  return "swap"; // √âchange = trade
}
```

---

## üìä Impact fiscal

**Pourquoi c'est important?**

- **TRADE**: √âv√©nement imposable
  - Calcul du gain/perte
  - Co√ªt de base
  - Prix de vente

- **TRANSFER**: G√©n√©ralement NON imposable
  - Simple mouvement de fonds
  - Pas de gain/perte
  - Juste un d√©placement

**Si on classe un TRADE comme TRANSFER:**
- ‚ùå Pas de calcul de taxes
- ‚ùå Rapport fiscal incomplet
- ‚ùå Probl√®mes avec l'administration fiscale

---

## ‚úÖ Action items

1. [ ] Auditer `parseTransaction()` dans `solana-transactions.ts`
2. [ ] Utiliser `enrichedTx.type` de Helius comme source de v√©rit√©
3. [ ] Ajouter une liste des program IDs de DEX connus
4. [ ] Logger les transactions ambigu√´s pour v√©rification manuelle
5. [ ] Ajouter des tests avec des vraies transactions de bots
6. [ ] V√©rifier sp√©cifiquement Axiom, Padre, Pump.fun

---

## üîç Debug checklist

Pour chaque transaction suspecte:
```javascript
console.log({
  signature: tx.signature,
  heliusType: tx.type,           // Ce que Helius dit
  ourType: parsedTx.type,         // Ce qu'on a d√©termin√©
  tokenTransfers: tx.tokenTransfers.length,
  hasSwapInstruction: /* v√©rifier */,
  source: tx.source
});
```

Si `heliusType !== ourType` ‚Üí Bug √† corriger!
